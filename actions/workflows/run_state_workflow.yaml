version: 1.0

description: Update run state and set various properties accordingly

input:
  - run_id
  - path
  - state

vars:
  - message: ""
  - update_run_state: null

output:
  - message: <% ctx().message %>

tasks:
  update_run_state:
    action: gmc_norr_seqdata.update_run_state
    input:
      run_id: <% ctx().run_id %>
      state: <% ctx().state %>
    next:
      - when: <% succeeded() and ctx().state = "ready" %>
        publish:
          - message: "state updated, will upload qc data {{ ctx() }}"
        do:
          - add_run_qc
      - when: <% succeeded() and ctx().state = "moved" %>
        publish:
          - message: "state updated, will update run path {{ ctx() }}"
        do:
          - update_run_path

  add_run_qc:
    action: gmc_norr_seqdata.add_run_qc
    input:
      run_id: <% ctx().run_id %>
    next:
      - do: noop

  update_run_path:
    action: gmc_norr_seqdata.update_run_path
    input:
      run_id: <% ctx().run_id %>
      path: <% ctx().path %>
    next:
      - do: noop
